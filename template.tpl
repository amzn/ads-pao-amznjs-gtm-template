___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Amazon Advertising Tag",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Amazon Advertising",
    "thumbnail": "data:image/png;base64,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"
  },
  "categories": [
    "ADVERTISING",
    "ATTRIBUTION",
    "CONVERSIONS"
  ],
  "description": "Amazon Advertising Tag template - version 3.4",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SIMPLE_TABLE",
    "name": "tagIds",
    "displayName": "",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Tags",
        "name": "TagIds",
        "type": "TEXT",
        "isUnique": true,
        "valueHint": "Tag Id from Amazon DSP",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "newRowButtonText": "Add Tag",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "RADIO",
    "name": "eventName",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "standardEventName",
            "macrosInSelect": false,
            "selectItems": [
              {
                "displayValue": "AddToShoppingCart",
                "value": "AddToShoppingCart"
              },
              {
                "displayValue": "Contact",
                "value": "Contact"
              },
              {
                "displayValue": "Checkout",
                "value": "Checkout"
              },
              {
                "displayValue": "PageView",
                "value": "PageView"
              },
              {
                "displayValue": "Search",
                "value": "Search"
              },
              {
                "displayValue": "Signup",
                "value": "Signup"
              },
              {
                "displayValue": "Application",
                "value": "Application"
              },
              {
                "displayValue": "Subscribe",
                "value": "Subscribe"
              },
              {
                "value": "Other",
                "displayValue": "Other"
              },
              {
                "value": "Lead",
                "displayValue": "Lead"
              },
              {
                "value": "Off-AmazonPurchases",
                "displayValue": "Off-AmazonPurchases"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "PageView"
          }
        ]
      },
      {
        "value": "custom",
        "displayValue": "Custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "customEventName",
            "displayName": "",
            "simpleValueType": true,
            "defaultValue": "default"
          }
        ]
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "RADIO",
    "name": "tagRegion",
    "displayName": "Region",
    "radioItems": [
      {
        "value": "NA",
        "displayValue": "North America, South America, Japan and Australia"
      },
      {
        "value": "EU",
        "displayValue": "Europe"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "NA"
  },
  {
    "type": "CHECKBOX",
    "name": "advancedMatching",
    "checkboxText": "Advanced Matching for User Data",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "advancedMatchingGroup",
    "displayName": "Customer Information Data Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "advancedMatchingList",
        "displayName": "User Data",
        "simpleTableColumns": [
          {
            "defaultValue": "Email",
            "displayName": "Parameter name",
            "name": "paramName",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "email",
                "displayValue": "Email"
              },
              {
                "value": "phone",
                "displayValue": "Phone Number"
              }
            ],
            "valueValidators": [],
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "paramValue",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY",
            "enablingConditions": []
          }
        ],
        "newRowButtonText": "Add parameter"
      },
      {
        "type": "TEXT",
        "name": "ttl",
        "displayName": "TTL",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "advancedMatching",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "advancedMatching",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "OffAmazonPurchaseAttributesField",
    "displayName": "Off-AmazonPurchase Attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "offAmazonPurchaseAttributes",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Attribute",
            "name": "Attribute",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "currencyCode",
                "displayValue": "currencyCode"
              },
              {
                "value": "unitsSold",
                "displayValue": "unitsSold"
              },
              {
                "value": "value",
                "displayValue": "value"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add Attribute",
        "enablingConditions": []
      }
    ],
    "enablingConditions": [
      {
        "paramName": "standardEventName",
        "paramValue": "Off-AmazonPurchases",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "DefaultAttributesField",
    "displayName": "Default Attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "defaultAttributes",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Attribute",
            "name": "Attribute",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "value",
                "displayValue": "value"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add Attribute",
        "enablingConditions": []
      }
    ],
    "enablingConditions": [
      {
        "paramName": "standardEventName",
        "paramValue": "Off-AmazonPurchases",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "CustomAttributesField",
    "displayName": "Custom Attributes",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customAttributes",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "key",
            "displayName": "Attribute",
            "name": "Attribute",
            "type": "TEXT"
          },
          {
            "defaultValue": "value",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add Attribute"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "TCFv2",
    "displayName": "TCFv2",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "includeTcf",
        "checkboxText": "Include TCFv2",
        "simpleValueType": true,
        "defaultValue": false
      },
      {
        "type": "SELECT",
        "name": "gdpr",
        "displayName": "GDPR consent",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": 0,
            "displayValue": "GDPR does not apply (0)"
          },
          {
            "value": 1,
            "displayValue": "GDPR applies (1)"
          },
          {
            "value": 2,
            "displayValue": "GDPR unknown (null)"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "includeTcf",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "defaultValue": -1
      },
      {
        "type": "TEXT",
        "name": "gdprConsent",
        "displayName": "TCFv2 consent string",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "includeTcf",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "defaultValue": ""
      },
      {
        "type": "SELECT",
        "name": "gdprPd",
        "displayName": "GDPR personal data",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": 0,
            "displayValue": "Does not contain personal data (0)"
          },
          {
            "value": 1,
            "displayValue": "Contains personal data (1)"
          },
          {
            "value": -1,
            "displayValue": "unknown (null)"
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "includeTcf",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "defaultValue": -1
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const version = "3.3";

const makeTableMap = require('makeTableMap');
const createArgumentsQueue = require('createArgumentsQueue');
const injectScript = require('injectScript');
const log = require('logToConsole');
const copyFromWindow = require('copyFromWindow');
const makeString = require('makeString');
const makeInteger = require('makeInteger');

// Helper methods
const mergeObj = (obj, obj2) => {
  for (let key in obj2) {
    if (obj2.hasOwnProperty(key)) {
      obj[key] = obj2[key];
    }
  }
  return obj;
};

const fail = msg => {
  log(msg);
  data.gtmOnFailure();
};


// Field processing
const tagIds = data.tagIds.map(item => item.TagIds).filter( item => item );

if (tagIds.length === 0) {
  return fail("No Amazon Ad Tag IDs configured");
}

let eventName = data.standardEventName;
if (data.eventName === "custom") {
  eventName = data.customEventName;
}

if (!eventName) {
  return fail("Event Name is not defined");
}

const region = data.tagRegion;

let attributes = {};
if (eventName === "Off-AmazonPurchases") {
  attributes = data.offAmazonPurchaseAttributes ? makeTableMap(data.offAmazonPurchaseAttributes, 'Attribute', 'value') : {};
} else {
  attributes = data.defaultAttributes ? makeTableMap(data.defaultAttributes, 'Attribute', 'value') : {};
}

const customAttributes = data.customAttributes ? makeTableMap(data.customAttributes, 'Attribute', 'value') : {};
const finalAttributes = mergeObj(attributes, customAttributes);
finalAttributes.gtmVersion = version;

for (const key in finalAttributes) {
  if (!key) {
    return fail("Attribute is not defined - " + key);
  }
}

const gdprAttributes = {};
let ttl = null;

if (data.includeTcf) {
  const possibleGDPRvalues = [0, 1, 2];
  if (possibleGDPRvalues.indexOf(data.gdpr) >= 0) gdprAttributes.gdpr = data.gdpr;

  const possibleGDPRPDvalues = [-1, 0, 1];
  if (possibleGDPRPDvalues.indexOf(data.gdprPd) >= 0) gdprAttributes.gdprPd = data.gdprPd;

  if (data.gdprConsent) gdprAttributes.gdprConsent = data.gdprConsent;
}

const tokenConfig = {
  email: '',
  phonenumber: '',
  gdpr: { enabled: false, consent: '',},
  ttl: 9600,
};

if (data.advancedMatchingList) {
  let ttl = null;
  if (data.ttl !== undefined && makeInteger(data.ttl) >= 0) ttl = makeInteger(data.ttl);

  data.advancedMatchingList.forEach((e) => {
    if (!e.paramName || !e.paramValue) {
      return;
    }

    const paramVal = makeString(e.paramValue);

    if (e.paramName === "email" && paramVal.length > 0) {
      // if token config email is already set, we don't want to
      tokenConfig.email = paramVal;
    }
    if (e.paramName === "phone" && paramVal.length > 0) {
      tokenConfig.phonenumber = paramVal;
    }
  });

  if (gdprAttributes.gdpr) {
    tokenConfig.gdpr.enabled = !!gdprAttributes.gdpr;
  }
  if (gdprAttributes.gdprConsent) {
    tokenConfig.gdpr.consent = gdprAttributes.gdprConsent;
  }

  if (tokenConfig.gdpr.enabled && !tokenConfig.gdpr.consent) {
    return fail("GDPR consent string must be set if GDPR enabled");
  }

  if (ttl) {
    tokenConfig.ttl = ttl;
  }
  log("token config =", tokenConfig);
}

// Define amzn fn in window
const getAmzn = () => {
  const amzn = copyFromWindow('amzn');
  if (amzn && !amzn.q) return amzn;

  // Until the full library is loaded we allow calling amzn by queuing all
  // calls to it. This queue is then processed when the library is loaded.
  const amznq = createArgumentsQueue('amzn', 'amzn.q');

  const overrideAmznFn = (a, b, c, d) => amznq([a, b, c, d]);
  return overrideAmznFn;
};

// track events once amznjs script is loaded
const trackEvents = () => {
  const amzn = getAmzn();
  if (!amzn) {
     return fail("Amazon Ad Tag not defined in browser window");
  }

  if (data.advancedMatchingList && ((tokenConfig.email !== '') || (tokenConfig.phonenumber !== ''))) {
     amzn('setUserData', tokenConfig);
  }

  amzn('setRegion', region);
  tagIds.forEach(item => amzn("addTag", item));
  amzn('addtcfv2', gdprAttributes);
  amzn('trackEvent', eventName, finalAttributes);
};

trackEvents();
injectScript('https://c.amazon-adsystem.com/aat/amzn.js', data.gtmOnSuccess, data.gtmOnFailure, 'amznScript');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "amzn"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "amzn.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://c.amazon-adsystem.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Library is injected
  code: |
    runCode(mockData);

    assertApi('injectScript').wasCalledWith(scriptUrl, success, failure, 'amznScript');
    assertApi('gtmOnSuccess').wasCalled();
- name: amzn does not exist in window, its created, and commands are inserted into
    the queue
  code: |
    const Calls = { "amznq" : []};

    mock('copyFromWindow', key => {
      if (key === 'amzn') return undefined;
    });

    const amznq = () => {
       Calls.amznq.push(arguments[0]);
    };

    mock('createArgumentsQueue', (key, q) => amznq);

    runCode(mockData);

    assertApi('createArgumentsQueue').wasCalledWith('amzn', 'amzn.q');
    assertThat(Calls.amznq.length).isEqualTo(4);
    assertThat(Calls.amznq[0]).isEqualTo(['setRegion', region, undefined, undefined]);
    assertThat(Calls.amznq[1]).isEqualTo(['addTag', tag1, undefined, undefined]);
    assertThat(Calls.amznq[2]).isEqualTo(['addtcfv2', {}, undefined, undefined]);
    assertThat(Calls.amznq[3]).isEqualTo(['trackEvent', eventName, { 'gtmVersion': version }, undefined]);

    assertApi('gtmOnSuccess').wasCalled();
- name: amzn exist in window, createArgumentsQueue is not Called
  code: |-
    mock('createArgumentsQueue', (key, q) => () => {});

    runCode(mockData);

    assertApi('createArgumentsQueue').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: with tcf - only includeTcf = true does not set any tcf attributes
  code: "mockData.includeTcf = true;\n  \nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(4);\n\
    assertThat(amznCalls[0]).isEqualTo(['setRegion', region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag',\
    \ tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2', {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent',\
    \ eventName, { gtmVersion: version }]);\nassertApi('gtmOnSuccess').wasCalled();"
- name: with tcf - includeTcf = true and gdpr value set
  code: "mockData.includeTcf = true;\n\nlet i = 0;\n\nwhile (i < 3) {\n  mockData.gdpr\
    \ = i;\n  runCode(mockData);\n\n  assertThat(amznCalls.length).isEqualTo(4);\n\
    \  assertThat(amznCalls[0]).isEqualTo(['setRegion', region]);\n  assertThat(amznCalls[1]).isEqualTo(['addTag',\
    \ tag1]);\n  assertThat(amznCalls[2]).isEqualTo(['addtcfv2', { gdpr: i }]);\n\
    \  assertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n  assertApi('gtmOnSuccess').wasCalled();\n  \n  amznCalls = [];\n\
    \  i += 1;\n}"
- name: with tcf - includeTcf = true and invalid gdpr value set
  code: "mockData.includeTcf = true;\n\nlet i = 3;\n\nwhile (i < 10) {\n  mockData.gdpr\
    \ = i;\n  runCode(mockData);\n\n  assertThat(amznCalls.length).isEqualTo(4);\n\
    \  assertThat(amznCalls[0]).isEqualTo(['setRegion', region]);\n  assertThat(amznCalls[1]).isEqualTo(['addTag',\
    \ tag1]);\n  assertThat(amznCalls[2]).isEqualTo(['addtcfv2', {}]);\n  assertThat(amznCalls[3]).isEqualTo(['trackEvent',\
    \ eventName, { gtmVersion: version }]);\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  \n  amznCalls = [];\n  i += 1;\n}"
- name: with tcf - includeTcf = true and gdprpd value set
  code: "mockData.includeTcf = true;\n\nlet i = -1;\n\nwhile (i < 2) {\n  mockData.gdprPd\
    \ = i;\n  runCode(mockData);\n\n  assertThat(amznCalls.length).isEqualTo(4);\n\
    \  assertThat(amznCalls[0]).isEqualTo(['setRegion', region]);\n  assertThat(amznCalls[1]).isEqualTo(['addTag',\
    \ tag1]);\n  assertThat(amznCalls[2]).isEqualTo(['addtcfv2', { gdprPd: i }]);\n\
    \  assertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n  assertApi('gtmOnSuccess').wasCalled();\n  \n  amznCalls = [];\n\
    \  i += 1;\n}"
- name: with tcf - includeTcf = true and gdprpd value is invalid
  code: "mockData.includeTcf = true;\n\nlet i = 2;\n\nwhile (i <= 9) {\n  mockData.gdprPd\
    \ = i;\n  runCode(mockData);\n\n  assertThat(amznCalls.length).isEqualTo(4);\n\
    \  assertThat(amznCalls[0]).isEqualTo(['setRegion', region]);\n  assertThat(amznCalls[1]).isEqualTo(['addTag',\
    \ tag1]);\n  assertThat(amznCalls[2]).isEqualTo(['addtcfv2', {}]);\n  assertThat(amznCalls[3]).isEqualTo(['trackEvent',\
    \ eventName, { gtmVersion: version }]);\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  \n  amznCalls = [];\n  i += 1;\n}"
- name: with tcf - includeTcf = true and gdprConsent present
  code: |
    mockData.includeTcf = true;
    mockData.gdprConsent = exampleTCFv2ConsentString;
    runCode(mockData);

    assertThat(amznCalls.length).isEqualTo(4);
    assertThat(amznCalls[0]).isEqualTo(['setRegion', region]);
    assertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);
    assertThat(amznCalls[2]).isEqualTo(['addtcfv2', { gdprConsent: exampleTCFv2ConsentString }]);
    assertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion: version }]);
    assertApi('gtmOnSuccess').wasCalled();
- name: with tcf - includeTcf = true and gdprConsent is falsy
  code: "mockData.includeTcf = true;\n\nfor (const falsyGdprConsent of [null, undefined,\
    \ '']) {\n  mockData.gdprConsent = falsyGdprConsent;\n  runCode(mockData);\n\n\
    \  assertThat(amznCalls.length).isEqualTo(4);\n  assertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\n  assertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\n  assertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\n  assertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n  assertApi('gtmOnSuccess').wasCalled();\n  \n  amznCalls = [];\n\
    }"
- name: with tcf - advancedMatching = true and ttl positive value
  code: "mockData.advancedMatchingList = [ { 'paramName': 'email', 'paramValue': 'test@test.com'\
    \ }];\n\nmockData.ttl = 10;\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: 'test@test.com',\n  phonenumber: '',\n  gdpr:\
    \ { enabled: false, consent: '',},\n  ttl: 10,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];\n"
- name: with tcf - advancedMatching = true and ttl negative value should not change
    default ttl
  code: "mockData.advancedMatchingList = [ { 'paramName': 'email', 'paramValue': 'test@test.com'\
    \ }];\n\nmockData.ttl = -10;\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: 'test@test.com',\n  phonenumber: '',\n  gdpr:\
    \ { enabled: false, consent: '',},\n  ttl: 9600,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];\n"
- name: with tcf - advancedMatching = true and ttl random string should not change
    default ttl
  code: "mockData.advancedMatchingList = [ { 'paramName': 'email', 'paramValue': 'test@test.com'\
    \ }];\n\nmockData.ttl = \"random\";\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: 'test@test.com',\n  phonenumber: '',\n  gdpr:\
    \ { enabled: false, consent: '',},\n  ttl: 9600,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];\n"
- name: Test Advanced Matching with Email
  code: "mockData.advancedMatchingList = [{\"paramName\":\"email\",\"paramValue\"\
    :\"jj\"}];\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: 'jj',\n  phonenumber: '',\n  gdpr: { enabled:\
    \ false, consent: '',},\n  ttl: 9600,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];"
- name: Test Advanced Matching with Phone
  code: |
    mockData.advancedMatchingList = [{"paramName":"phone","paramValue":"kk"}];


    runCode(mockData);

    assertThat(amznCalls.length).isEqualTo(5);

    const tokenConfig = {
      email: '',
      phonenumber: 'kk',
      gdpr: { enabled: false, consent: '',},
      ttl: 9600,
    };

    assertThat(amznCalls[0]).isEqualTo(['setUserData', tokenConfig]);
    assertThat(amznCalls[1]).isEqualTo(['setRegion', region]);
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);
    assertThat(amznCalls[3]).isEqualTo(['addtcfv2', {}]);
    assertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion: version }]);
    assertApi('gtmOnSuccess').wasCalled();

    amznCalls = [];
- name: Test Advanced Matching with Phone as number
  code: |
    mockData.advancedMatchingList = [{"paramName":"phone","paramValue":22}];


    runCode(mockData);

    assertThat(amznCalls.length).isEqualTo(5);

    const tokenConfig = {
      email: '',
      phonenumber: '22',
      gdpr: { enabled: false, consent: '',},
      ttl: 9600,
    };

    assertThat(amznCalls[0]).isEqualTo(['setUserData', tokenConfig]);
    assertThat(amznCalls[1]).isEqualTo(['setRegion', region]);
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);
    assertThat(amznCalls[3]).isEqualTo(['addtcfv2', {}]);
    assertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion: version }]);
    assertApi('gtmOnSuccess').wasCalled();

    amznCalls = [];
- name: Test Advanced Matching with Email as number
  code: "mockData.advancedMatchingList = [{\"paramName\":\"email\",\"paramValue\"\
    : 33}];\n\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: '33',\n  phonenumber: '',\n  gdpr: { enabled:\
    \ false, consent: '',},\n  ttl: 9600,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];\n"
- name: Test Advanced Matching with Email and Phone
  code: |
    mockData.advancedMatchingList = [{"paramName":"email","paramValue": "aa"},{"paramName":"phone","paramValue":"kk"}];


    runCode(mockData);

    assertThat(amznCalls.length).isEqualTo(5);

    const tokenConfig = {
      email: 'aa',
      phonenumber: 'kk',
      gdpr: { enabled: false, consent: '',},
      ttl: 9600,
    };

    assertThat(amznCalls[0]).isEqualTo(['setUserData', tokenConfig]);
    assertThat(amznCalls[1]).isEqualTo(['setRegion', region]);
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);
    assertThat(amznCalls[3]).isEqualTo(['addtcfv2', {}]);
    assertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion: version }]);
    assertApi('gtmOnSuccess').wasCalled();

    amznCalls = [];
- name: Test Advanced Matching with Email and null Phone
  code: "mockData.advancedMatchingList = [{\"paramName\":\"email\",\"paramValue\"\
    : \"aa\"},{\"paramName\":\"phone\",\"paramValue\": null}];\n\n\nrunCode(mockData);\n\
    \nassertThat(amznCalls.length).isEqualTo(5);\n\nconst tokenConfig = {\n  email:\
    \ 'aa',\n  phonenumber: '',\n  gdpr: { enabled: false, consent: '',},\n  ttl:\
    \ 9600,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData', tokenConfig]);\n\
    assertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\nassertThat(amznCalls[2]).isEqualTo(['addTag',\
    \ tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2', {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent',\
    \ eventName, { gtmVersion: version }]);\nassertApi('gtmOnSuccess').wasCalled();\n\
    \n  \namznCalls = [];\n"
- name: Test Advanced Matching with null Email and Phone
  code: |
    mockData.advancedMatchingList = [{"paramName":"email","paramValue": null},{"paramName":"phone","paramValue": "bb"}];


    runCode(mockData);

    assertThat(amznCalls.length).isEqualTo(5);

    const tokenConfig = {
      email: '',
      phonenumber: 'bb',
      gdpr: { enabled: false, consent: '',},
      ttl: 9600,
    };

    assertThat(amznCalls[0]).isEqualTo(['setUserData', tokenConfig]);
    assertThat(amznCalls[1]).isEqualTo(['setRegion', region]);
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);
    assertThat(amznCalls[3]).isEqualTo(['addtcfv2', {}]);
    assertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion: version }]);
    assertApi('gtmOnSuccess').wasCalled();

    amznCalls = [];
- name: Test Advanced Matching with null Email and null Phone
  code: "mockData.advancedMatchingList = [{\"paramName\":\"email\",\"paramValue\"\
    : null},{\"paramName\":\"phone\",\"paramValue\": null}];\n     \n// Call runCode\
    \ to run the template's code.\nrunCode(mockData);\nlog(amznCalls);\n\n// No setUserData\
    \ called\nassertThat(amznCalls.length).isEqualTo(4);\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n\nassertApi('gtmOnSuccess').wasCalled();\n\namznCalls = [];"
- name: Test Advanced Matching with undefined paramValue
  code: "mockData.advancedMatchingList = [{\"paramName\":\"email\"}];\n\n     \n//\
    \ Call runCode to run the template's code.\nrunCode(mockData);\n\n// No setUserData\
    \ called\nassertThat(amznCalls.length).isEqualTo(4);\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n\nassertApi('gtmOnSuccess').wasCalled();\namznCalls = [];"
- name: Test Advanced Matching with undefined paramName
  code: "mockData.advancedMatchingList = [{\"paramValue\":\"aa\"}];\n\n     \n// Call\
    \ runCode to run the template's code.\nrunCode(mockData);\n\n// No setUserData\
    \ called\nassertThat(amznCalls.length).isEqualTo(4);\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n\nassertApi('gtmOnSuccess').wasCalled();\namznCalls = [];"
- name: Testing Advanced Matching without TCF
  code: "mockData.includeTcf = false;\nmockData.gdpr = 1;\nmockData.gdprConsent =\
    \ \"asd\";\nmockData.advancedMatchingList = [{\"paramName\":\"email\",\"paramValue\"\
    : \"aa\"}];\n\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: 'aa',\n  phonenumber: '',\n  gdpr: { enabled:\
    \ false, consent: '',},\n  ttl: 9600,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];\n\n"
- name: Testing Advanced Matching with TCF and GDPR consent
  code: "mockData.includeTcf = true;\nmockData.gdpr = 1;\nmockData.gdprConsent = \"\
    asd\";\nmockData.ttl = 9000;\nmockData.advancedMatchingList = [{\"paramName\"\
    :\"email\",\"paramValue\": \"aa\"}];\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(5);\n\
    \nconst tokenConfig = {\n  email: 'aa',\n  phonenumber: '',\n  gdpr: { enabled:\
    \ true, consent: 'asd',},\n  ttl: 9000,\n};\n\nassertThat(amznCalls[0]).isEqualTo(['setUserData',\
    \ tokenConfig]);\nassertThat(amznCalls[1]).isEqualTo(['setRegion', region]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[3]).isEqualTo(['addtcfv2',\
    \ {gdpr: 1, gdprConsent: 'asd'}]);\nassertThat(amznCalls[4]).isEqualTo(['trackEvent',\
    \ eventName, { gtmVersion: version }]);\nassertApi('gtmOnSuccess').wasCalled();\n\
    \  \namznCalls = [];\n\n"
- name: Testing Advanced Matching with TCF and no GDPR consent
  code: "mockData.includeTcf = true;\nmockData.gdpr = 1;\nmockData.gdprConsent = \"\
    \";\nmockData.ttl = 9000;\nmockData.advancedMatchingList = [{\"paramName\":\"\
    email\",\"paramValue\": \"aa\"},{\"paramName\":\"phone\",\"paramValue\":\"kk\"\
    }];\n     \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n\
    assertApi('gtmOnFailure').wasCalled();\n\namznCalls = [];"
- name: Test Default attributes with Custom attributes
  code: "mockData.defaultAttributes = [\n  {'Attribute': 'k1', 'value': 'v1'},\n \
    \ {'Attribute': 'k2', 'value': 'v2'}\n];\nmockData.customAttributes = [\n  {'Attribute':\
    \ 'a1', 'value': 'b1'},\n  {'Attribute': 'a2', 'value': 'b2'}\n];\n\nrunCode(mockData);\n\
    \nassertThat(amznCalls.length).isEqualTo(4);\n\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, {\"k1\"\
    :\"v1\",\"k2\":\"v2\",\"a1\":\"b1\",\"a2\":\"b2\",\"gtmVersion\":version}]);\n\
    assertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];"
- name: Test Default attributes
  code: "mockData.defaultAttributes = [\n  {'Attribute': 'k1', 'value': 'v1'},\n \
    \ {'Attribute': 'k2', 'value': 'v2'}\n];\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(4);\n\
    \nassertThat(amznCalls[0]).isEqualTo(['setRegion', region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag',\
    \ tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2', {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent',\
    \ eventName, {\"k1\":\"v1\",\"k2\":\"v2\",\"gtmVersion\":version}]);\nassertApi('gtmOnSuccess').wasCalled();\n\
    \  \namznCalls = [];"
- name: Test Default attributes do not appear with Off-AmazonPurchases
  code: "mockData.defaultAttributes = [\n  {'Attribute': 'k1', 'value': 'v1'},\n \
    \ {'Attribute': 'k2', 'value': 'v2'}\n];\nmockData.standardEventName = \"Off-AmazonPurchases\"\
    ;\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(4);\n\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', \"Off-AmazonPurchases\"\
    , {\"gtmVersion\":version}]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls\
    \ = [];"
- name: Test Custom attributes do appear with Off-AmazonPurchases
  code: "mockData.customAttributes = [\n  {'Attribute': 'k1', 'value': 'v1'},\n  {'Attribute':\
    \ 'k2', 'value': 'v2'}\n];\nmockData.standardEventName = \"Off-AmazonPurchases\"\
    ;\n\nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(4);\n\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', \"Off-AmazonPurchases\"\
    , {\"k1\": \n\"v1\", \"k2\": \"v2\", \"gtmVersion\":version}]);\nassertApi('gtmOnSuccess').wasCalled();\n\
    \  \namznCalls = [];"
- name: Test Custom event name
  code: "mockData.eventName = \"custom\";\nmockData.customEventName = \"custom\";\n\
    \nrunCode(mockData);\n\nassertThat(amznCalls.length).isEqualTo(4);\n\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', \"custom\", {\"gtmVersion\"\
    :version}]);\nassertApi('gtmOnSuccess').wasCalled();\n  \namznCalls = [];"
- name: Test Undefined standard event name
  code: "mockData.standardEventName = undefined;\n\nrunCode(mockData);\n\nassertApi('gtmOnFailure').wasCalled();\n\
    \  \namznCalls = [];"
- name: Test Undefined custom event name
  code: "mockData.eventName = \"custom\";\nmockData.customEventName = undefined;\n\
    \nrunCode(mockData);\n\nassertApi('gtmOnFailure').wasCalled();\n  \namznCalls\
    \ = [];"
- name: Test multiple Tag Ids
  code: "mockData.tagIds = [{ TagIds: [tag1, \"tag2\"] }];\n\nrunCode(mockData);\n\
    \nassertThat(amznCalls.length).isEqualTo(4);\n\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', [tag1, \"tag2\"]]);\n\
    assertThat(amznCalls[2]).isEqualTo(['addtcfv2', {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent',\
    \ eventName, {\"gtmVersion\":version}]);\nassertApi('gtmOnSuccess').wasCalled();\n\
    \  \namznCalls = [];"
- name: Test no Tag Id fails
  code: "mockData.tagIds = [];\n\nrunCode(mockData);\n\nassertApi('gtmOnFailure').wasCalled();\n\
    \  \namznCalls = [];"
- name: with tcf - only includeTcf = false and no tcf attributes are set
  code: "mockData.includeTcf = false;\nmockData.gdpr = 1;\nmockData.gdprConsent =\
    \ exampleTCFv2ConsentString;\nmockData.gdprPd = 1;\n  \nrunCode(mockData);\n\n\
    assertThat(amznCalls.length).isEqualTo(4);\nassertThat(amznCalls[0]).isEqualTo(['setRegion',\
    \ region]);\nassertThat(amznCalls[1]).isEqualTo(['addTag', tag1]);\nassertThat(amznCalls[2]).isEqualTo(['addtcfv2',\
    \ {}]);\nassertThat(amznCalls[3]).isEqualTo(['trackEvent', eventName, { gtmVersion:\
    \ version }]);\n\nassertApi('gtmOnSuccess').wasCalled();"
setup: |-
  const log = require('logToConsole');

  const tag1 = 'tagId1';
  const eventName = 'PageView';
  const region = 'NA';
  const version = '3.3';
  const exampleTCFv2ConsentString = 'COw4XqLOw4XqLAAAAAENAXCAAAAAAAAAAAAAAAAAAAAA.IFukWSQgAIQwgI0QEByFAAAAeIAACAIgSAAQAIAgEQACEABAAAgAQFAEAIAAAGBAAgAAAAQAIFAAMCQAAgAAQiRAEQAAAAANAAIAAggAIYQFAAARmggBC3ZCYzU2yIA.QFukWSQgAIQwgI0QEByFAAAAeIAACAIgSAAQAIAgEQACEABAAAgAQFAEAIAAAGBAAgAAAAQAIFAAMCQAAgAAQiRAEQAAAAANAAIAAggAIYQFAAARmggBC3ZCYzU2yIA.YAAAAAAAAAAAAAAAAAA'; // https://github.com/InteractiveAdvertisingBureau/GDPR-Transparency-and-Consent-Framework/blob/master/TCFv2/IAB%20Tech%20Lab%20-%20Consent%20string%20and%20vendor%20list%20formats%20v2.md#tc-string-format

  const mockData = {
    tagIds: [{ TagIds: tag1 }],
    standardEventName: eventName,
    tagRegion: region,
  };

  const scriptUrl = 'https://c.amazon-adsystem.com/aat/amzn.js';

  mock('logToConsole', function() {
    // Print out logs, as normally as possible
    log(arguments); // Note: bind and call not available
  });

  let success, failure;
  mock('injectScript', (url, onsuccess, onfailure) => {
    success = onsuccess;
    failure = onfailure;
    onsuccess();
  });

  let amznCalls = [];

  const amzn = () => {
     amznCalls.push(arguments);
  };

  mock('copyFromWindow', key => {
    if (key === 'amzn') return amzn;
  });


___NOTES___

Created on 3/26/2020, 3:08:52 PM


